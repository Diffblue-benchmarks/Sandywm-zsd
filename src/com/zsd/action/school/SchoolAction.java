/*
 * Generated by MyEclipse Struts
 * Template path: templates/java/JavaClass.vtl
 */
package com.zsd.action.school;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.Iterator;
import java.util.List;
import java.util.Map;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import org.apache.struts.action.ActionForm;
import org.apache.struts.action.ActionForward;
import org.apache.struts.action.ActionMapping;
import org.apache.struts.actions.DispatchAction;

import com.zsd.action.base.Transcode;
import com.zsd.factory.AppFactory;
import com.zsd.module.School;
import com.zsd.page.PageConst;
import com.zsd.service.SchoolManager;
import com.zsd.tools.CommonTools;
import com.zsd.util.Constants;

/** 
 * MyEclipse Struts
 * Creation date: 04-29-2019
 * 
 * XDoclet definition:
 * @struts.action validate="true"
 */
public class SchoolAction extends DispatchAction {
	
	/**
	 * 导向学校管理模块
	 * @author  Administrator
	 * @ModifiedBy  
	 * @date  2019-5-1 下午04:31:05
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward goSchoolPage(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		return mapping.findForward("schoolPage");
	}
	
	/**
	 * 根据条件分页获取学校列表
	 * @author Administrator
	 * @date 2019-4-29 下午03:56:37
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward getPageSchoolData(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		SchoolManager sm = (SchoolManager) AppFactory.instance(null).getApp(Constants.WEB_SCHOOL_INFO);
		String schoolName = Transcode.unescape_new("schoolName", request);
		String prov = Transcode.unescape_new("prov", request);
		String city = Transcode.unescape_new("city", request);
		String county = Transcode.unescape_new("county", request);
		String town = Transcode.unescape_new("town", request);
		Integer schoolType = CommonTools.getFinalInteger("schoolType", request);
		Integer count = sm.getCountByOpt(schoolName, prov, city, county, town, schoolType, -1);
		String msg = "noInfo";
		Map<String,Object> map = new HashMap<String,Object>();
		if(count > 0){
			Integer pageSize = PageConst.getPageSize(String.valueOf(request.getParameter("limit")), 10);//等同于pageSize
			Integer pageNo = CommonTools.getFinalInteger("page", request);//等同于pageNo
			List<School> sList = sm.listPageInfoByOpt(schoolName, prov, city, county, town, schoolType, -1, pageNo, pageSize);
			List<Object> list_d = new ArrayList<Object>();
			for(Iterator<School> it = sList.iterator() ; it.hasNext();){
				School sch = it.next();
				Map<String,Object> map_d = new HashMap<String,Object>();
				map_d.put("id", sch.getId());
				map_d.put("schoolName", sch.getSchoolName());
				map_d.put("prov", sch.getProv());
				map_d.put("city", sch.getCity());
				map_d.put("county", sch.getCounty());
				map_d.put("town", sch.getTown());
				Integer schoolType_db = sch.getSchoolType();
				String schoolTypeChi = "";
				if(schoolType_db.equals(1)){
					schoolTypeChi = "小学";
				}else if(schoolType_db.equals(2)){
					schoolTypeChi = "初中";
				}else if(schoolType_db.equals(3)){
					schoolTypeChi = "高中";
				}
				map_d.put("schoolType", schoolTypeChi);
				map_d.put("yearSystem", sch.getYearSystem()+"年制");
				if(sch.getShowStatus().equals(0)){
					map_d.put("showStatus", "显示");
				}else{
					map_d.put("showStatus", "隐藏");
				}
				list_d.add(map_d);
			}
			map.put("data", list_d);
			map.put("count", count);
			map.put("code", 0);
			msg = "success";
		}
		map.put("result", msg);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 检查学校名称是否存在
	 * @author Administrator
	 * @date 2019-4-29 下午04:02:54
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward checkExistSchoolName(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		SchoolManager sm = (SchoolManager) AppFactory.instance(null).getApp(Constants.WEB_SCHOOL_INFO);
		String schoolName = Transcode.unescape_new("schoolName", request);
		String msg = "error";
		Map<String,String> map = new HashMap<String,String>();
		if(!schoolName.equals("")){
			List<School> sList = sm.listInfoBySName(schoolName);
			if(sList.size() > 0){
				msg = "exist";
			}else{
				msg = "noInfo";
			}
		}
		map.put("result", msg);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	
	/**
	 * 根据学校编号获取学校详情
	 * @author Administrator
	 * @date 2019-4-29 下午03:57:33
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward getSchoolDetail(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		SchoolManager sm = (SchoolManager) AppFactory.instance(null).getApp(Constants.WEB_SCHOOL_INFO);
		Integer schoolId = CommonTools.getFinalInteger("schoolId", request);
		List<School> sList = sm.listInfoById(schoolId);
		Map<String,Object> map = new HashMap<String,Object>();
		String msg = "noInfo";
		if(sList.size() > 0){
			msg = "success";
			School sch = sList.get(0);
			map.put("id", sch.getId());
			map.put("schoolName", sch.getSchoolName());
			map.put("prov", sch.getProv());
			map.put("city", sch.getCity());
			map.put("county", sch.getCounty());
			map.put("town", sch.getTown());
			map.put("schoolType", sch.getSchoolType());
			map.put("yearSystem", sch.getYearSystem());
			map.put("showStatus", sch.getShowStatus());
		}
		map.put("result", msg);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
	
	/**
	 * 修改指定学校详情
	 * @author Administrator
	 * @date 2019-4-29 下午04:00:37
	 * @param mapping
	 * @param form
	 * @param request
	 * @param response
	 * @return
	 * @throws Exception
	 */
	public ActionForward updateSchool(ActionMapping mapping, ActionForm form,
			HttpServletRequest request, HttpServletResponse response) throws Exception {
		// TODO Auto-generated method stub
		SchoolManager sm = (SchoolManager) AppFactory.instance(null).getApp(Constants.WEB_SCHOOL_INFO);
		Integer schoolId = CommonTools.getFinalInteger("schoolId", request);
		String schoolName = Transcode.unescape_new("schoolName", request);
		String prov = Transcode.unescape_new("prov", request);
		String city = Transcode.unescape_new("city", request);
		String county = Transcode.unescape_new("county", request);
		String town = Transcode.unescape_new("town", request);
		Integer schoolType = CommonTools.getFinalInteger("schoolType", request);
		Integer yearSystem = CommonTools.getFinalInteger("yearSystem", request);
		Integer showStatus = CommonTools.getFinalInteger("showStatus", request);
		List<School> sList = sm.listInfoById(schoolId);
		Map<String,Object> map = new HashMap<String,Object>();
		String msg = "fail";
		if(sList.size() > 0){
			String schoolName_db = sList.get(0).getSchoolName();
			if(!schoolName_db.equals(schoolName)){
				//不相同，需要检查学校名是否存在
				List<School> sList_1 = sm.listInfoBySName(schoolName);
				if(sList_1.size() > 0){
					//存在，不能修改
					msg = "exist";
				}else{
					sm.updateSchoolInfoById(schoolId, schoolName, prov, city, county, town, schoolType, yearSystem, showStatus);
					msg = "success";
				}
			}
		}
		map.put("result", msg);
		CommonTools.getJsonPkg(map, response);
		return null;
	}
}